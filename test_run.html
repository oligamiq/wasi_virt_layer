<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>WASI on the Web - worker-run</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, "Hiragino Kaku Gothic ProN", "Noto Sans JP", "Yu Gothic UI", sans-serif; margin: 0; background: #0b1020; color: #eef2ff; }
    header { padding: 16px 20px; border-bottom: 1px solid #20263a; position: sticky; top: 0; background: #0b1020; }
    h1 { margin: 0; font-size: 18px; letter-spacing: .3px; }
    main { padding: 20px; display: grid; gap: 16px; }
    .row { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
    button { padding: 10px 14px; border-radius: 10px; border: 0; background: #4c6fff; color: white; font-weight: 600; cursor: pointer; }
    button:disabled { opacity: .6; cursor: not-allowed; }
    .badge { padding: 4px 8px; border-radius: 999px; background: #17203a; color: #9fb2ff; font-size: 12px; }
    .console { background: #0e1530; border: 1px solid #1b2344; border-radius: 12px; min-height: 220px; padding: 12px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size: 13px; overflow: auto; }
    .log { white-space: pre-wrap; margin: 0; }
    a { color: #9fb2ff; }
  </style>
</head>
<body>
  <header>
    <h1>WASI on the Web - worker-run</h1>
  </header>
  <main>
    <div class="row">
      <button id="runBtn">Run (worker)</button>
      <span id="isoBadge" class="badge"></span>
      <span class="badge">Requires: <code>threads_vfs.js</code> in <code>./dist/</code></span>
    </div>
    <section class="console" id="console"></section>
    <p>
      このページはメインスレッドではなく、<strong>Web Worker（module worker）</strong>上で WASI の初期化と実行を行う。SharedArrayBuffer を使う場合は COOP/COEP ヘッダが必須。
    </p>
  </main>

  <script type="module">
    const elConsole = document.getElementById('console');
    const runBtn = document.getElementById('runBtn');
    const isoBadge = document.getElementById('isoBadge');

    const append = (text, cls = 'log', color) => {
      const line = document.createElement('div');
      line.className = cls;
      if (color) line.style.color = color;
      line.textContent = text;
      elConsole.appendChild(line);
      elConsole.scrollTop = elConsole.scrollHeight;
      console.log(text);
    };

    const iso = self.crossOriginIsolated === true;
    isoBadge.textContent = iso ? 'crossOriginIsolated: true ✅' : 'crossOriginIsolated: false ⚠️ Set COOP/COEP headers';

    // Create a module worker using a Blob URL so we keep a single-file distribution.
    const workerCode = `
import { ConsoleStdout, File, OpenFile, PreopenDirectory, WASI } from "https://esm.sh/@bjorn3/browser_wasi_shim";
import { instantiate } from "${location.origin}/dist/threads_vfs.js";

const postLog = (type, msg) => {
  console.log({ type, msg });
  postMessage({ type, msg });
};

function snakeToCamel(snakeCaseString) {
  return snakeCaseString.toLowerCase().replace(/_([a-z])/g, (m, letter) => letter.toUpperCase());
}

self.onmessage = async (ev) => {
  const data = ev.data || {};
  if (data.cmd === 'run') {
    try {
      postLog('status', { running: true });
      const args = data.args || ["bin", "arg1", "arg2"];
      const env = data.env || ["FOO=bar"];
      const fds = [
        new OpenFile(new File([])),
        ConsoleStdout.lineBuffered((msg) => postLog('stdout', msg)),
        ConsoleStdout.lineBuffered((msg) => postLog('stderr', msg)),
        new PreopenDirectory('.', new Map()),
      ];
      const wasi = new WASI(args, env, fds);

      const imports = {};
      for (const key in wasi.wasiImport) {
        const inner_key = \`\${snakeToCamel(key)}Import\`;
        imports[inner_key] = (...a) => wasi.wasiImport[key](...a);
      }
      postLog('log', 'WASI imports proxied: ' + Object.keys(imports).join(','));

      const root = await instantiate(undefined, {
        "wasip1-vfs:host/virtual-file-system-wasip1-core": { Wasip1: imports },
        "wasip1-vfs:host/virtual-file-system-wasip1-threads-import": {
          Wasip1Threads: {
            threadSpawnImport: (...spawnArgs) => {
              postLog('error', 'threadSpawnImport is not implemented in this example worker.');
              throw new Error('threadSpawnImport not implemented');
            },
          }
        },
      }, async (module, importsObj) => {
        postLog('log', 'Preparing WebAssembly imports...');
        // SharedArrayBuffer を使う場合は crossOriginIsolated が必要。
        importsObj.env = {
          memory: new WebAssembly.Memory({ initial: 34, maximum: 34, shared: true })
        };
        const inst = await WebAssembly.instantiate(module, importsObj);
        return inst;
      });

      // Start WASI with custom _start
      wasi.start({
        exports: {
          memory: root.memory || undefined,
          _start: () => {
            postLog('log', '[WASI main] Calling root.start() and root.main()');
            try { root.start(); } catch (e) { postLog('error', e && e.message ? e.message : String(e)); }
            postLog('log', '[WASI main] root.start() called');
            postLog('log', '[WASI main] Calling root.main()');
            try { root.main(); } catch (e) { postLog('error', e && e.message ? e.message : String(e)); }
            postLog('log', '[WASI main] root.main() returned');
          }
        }
      });

      postLog('done', 'WASI finished');
    } catch (e) {
      postLog('error', e && e.message ? e.message : String(e));
    } finally {
      postLog('status', { running: false });
    }
  }
};

postMessage({ type: 'ready' });
`;

    const blob = new Blob([workerCode], { type: 'application/javascript' });
    const worker = new Worker(URL.createObjectURL(blob), { type: 'module' });

    let workerReady = false;
    let workerRunning = false;

    worker.addEventListener('message', (ev) => {
      const { type, msg } = ev.data || {};
      switch (type) {
        case 'ready':
          workerReady = true;
          append('Worker ready (WASI will run off the main thread)');
          break;
        case 'log':
          append('[worker] ' + String(msg));
          break;
        case 'stdout':
          append('[WASI stdout] ' + String(msg));
          break;
        case 'stderr':
          append('[WASI stderr] ' + String(msg), 'log', '#ffdb89');
          break;
        case 'error':
          append('[worker error] ' + String(msg), 'log', '#ff8a8a');
          break;
        case 'done':
          append('[worker done] ' + String(msg));
          break;
        case 'status':
          if (msg && msg.running !== undefined) {
            workerRunning = !!msg.running;
            runBtn.disabled = workerRunning || !workerReady;
          }
          break;
        default:
          append('[worker message] ' + JSON.stringify(ev.data));
      }
    });

    worker.addEventListener('error', (e) => {
      append('[worker uncaught error] ' + e.message, 'log', '#ff8a8a');
    });

    runBtn.addEventListener('click', () => {
      if (!workerReady) { append('Worker is not ready'); return; }
      if (workerRunning) { append('Worker is already running'); return; }
      append('Starting WASI in worker');
      worker.postMessage({ cmd: 'run', args: ['bin', 'arg1', 'arg2'], env: ['FOO=bar'] });
    });

  </script>
</body>
</html>
